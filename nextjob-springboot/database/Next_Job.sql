------------------------------------------------------------
-- NEXT JOB - Inteligência que impulsiona sua carreira.


-- USUARIOS
-- LUIZ FELIPE - RM 555197
-- MATHEUS MUNUERA - RM 557812
-- PEDRO GOMES - RM 553907
------------------------------------------------------------


-- SCRIPT DE LIMPEZA COMPLETA DO BANCO

-- Dropar pacotes
DROP PACKAGE pkg_inicializacao;
DROP PACKAGE pkg_recomendacao;
DROP PACKAGE pkg_conhecimento;
DROP PACKAGE pkg_vaga;
DROP PACKAGE pkg_usuario;

-- Dropar triggers
DROP TRIGGER trg_aud_usuario;
DROP TRIGGER trg_aud_empresa;
DROP TRIGGER trg_aud_vaga;
DROP TRIGGER trg_aud_curso;
DROP TRIGGER trg_aud_competencia;
DROP TRIGGER trg_aud_usuario_competencia;
DROP TRIGGER trg_aud_vaga_competencia;
DROP TRIGGER trg_aud_recomendacao;

-- Dropar tabelas
DROP TABLE auditoria CASCADE CONSTRAINTS;
DROP TABLE recomendacao CASCADE CONSTRAINTS;
DROP TABLE vaga_competencia CASCADE CONSTRAINTS;
DROP TABLE usuario_competencia CASCADE CONSTRAINTS;
DROP TABLE competencia CASCADE CONSTRAINTS;
DROP TABLE vaga CASCADE CONSTRAINTS;
DROP TABLE curso CASCADE CONSTRAINTS;
DROP TABLE empresa CASCADE CONSTRAINTS;
DROP TABLE usuario CASCADE CONSTRAINTS;


-- Criação das tabelas
--------------------------------------------------------------------

-- TABELA: USUARIO
CREATE TABLE usuario (
    id_usuario NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    nome VARCHAR2(150) NOT NULL,
    data_nascimento DATE NOT NULL,
    email VARCHAR2(150) UNIQUE NOT NULL,
    telefone VARCHAR2(20),
    endereco VARCHAR2(255),
    cpf VARCHAR2(14) UNIQUE NOT NULL,
    resumo_profissional CLOB,
    data_cadastro DATE DEFAULT SYSDATE
);

-- TABELA: EMPRESA
CREATE TABLE empresa (
    id_empresa NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    nome_fantasia VARCHAR2(150) NOT NULL,
    razao_social VARCHAR2(200) NOT NULL,
    cnpj VARCHAR2(18) UNIQUE NOT NULL,
    area_atuacao VARCHAR2(100),
    porte_empresa VARCHAR2(50),
    telefone VARCHAR2(20),
    email_corporativo VARCHAR2(150),
    endereco VARCHAR2(255),
    data_cadastro DATE DEFAULT SYSDATE
);

-- TABELA: VAGA
CREATE TABLE vaga (
    id_vaga NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    id_empresa NUMBER NOT NULL,
    titulo_vaga VARCHAR2(150) NOT NULL,
    senioridade VARCHAR2(50),
    salario NUMBER(10,2),
    carga_horaria_semana NUMBER,
    tipo_contrato VARCHAR2(50),
    localizacao VARCHAR2(150),
    descricao_completa CLOB,
    quantidade_vagas NUMBER,
    data_publicacao DATE DEFAULT SYSDATE,
    status_vaga VARCHAR2(50),
    CONSTRAINT fk_vaga_empresa FOREIGN KEY (id_empresa) REFERENCES empresa(id_empresa)
);

-- TABELA: COMPETENCIA
CREATE TABLE competencia (
    id_competencia NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    nome_competencia VARCHAR2(150) NOT NULL,
    tipo_competencia VARCHAR2(50), -- tecnica / soft skill
    categoria VARCHAR2(100),
    descricao CLOB,
    nivel_referencial VARCHAR2(50)
);

-- TABELA: USUARIO_COMPETENCIA
CREATE TABLE usuario_competencia (
    id_usuario NUMBER NOT NULL,
    id_competencia NUMBER NOT NULL,
    nivel_usuario VARCHAR2(50),
    tempo_experiencia NUMBER(4,1),
    certificado VARCHAR2(1),
    nivel_escolaridade VARCHAR2(100),
    data_registro DATE DEFAULT SYSDATE,
    CONSTRAINT pk_usuario_competencia PRIMARY KEY (id_usuario, id_competencia),
    CONSTRAINT fk_uc_usuario FOREIGN KEY (id_usuario) REFERENCES usuario(id_usuario),
    CONSTRAINT fk_uc_competencia FOREIGN KEY (id_competencia) REFERENCES competencia(id_competencia)
);

-- TABELA: VAGA_COMPETENCIA
CREATE TABLE vaga_competencia (
    id_vaga NUMBER NOT NULL,
    id_competencia NUMBER NOT NULL,
    obrigatoria VARCHAR2(1),
    nivel_minimo VARCHAR2(50),
    CONSTRAINT pk_vaga_competencia PRIMARY KEY (id_vaga, id_competencia),
    CONSTRAINT fk_vc_vaga FOREIGN KEY (id_vaga) REFERENCES vaga(id_vaga),
    CONSTRAINT fk_vc_competencia FOREIGN KEY (id_competencia) REFERENCES competencia(id_competencia)
);

 

-- TABELA: CURSO
CREATE TABLE curso (
    id_curso NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    nome_curso VARCHAR2(150) NOT NULL,
    plataforma VARCHAR2(100),
    categoria VARCHAR2(100),
    carga_horaria NUMBER,
    gratuito VARCHAR2(1),
    descricao CLOB,
    data_cadastro DATE DEFAULT SYSDATE
);

-- TABELA: RECOMENDACAO
CREATE TABLE recomendacao (
    id_recomendacao NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    id_usuario NUMBER NOT NULL,
    id_vaga NUMBER,
    id_curso NUMBER,
    tipo_recomendacao VARCHAR2(50),
    texto_recomendacao CLOB,
    nivel_prioridade VARCHAR2(50),
    data_geracao DATE DEFAULT SYSDATE,
    CONSTRAINT fk_rec_usuario FOREIGN KEY (id_usuario) REFERENCES usuario(id_usuario),
    CONSTRAINT fk_rec_vaga FOREIGN KEY (id_vaga) REFERENCES vaga(id_vaga),
    CONSTRAINT fk_rec_curso FOREIGN KEY (id_curso) REFERENCES curso(id_curso)
);

-- TABELA: AUDITORIA
CREATE TABLE auditoria (
    id_auditoria NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    tabela_afetada VARCHAR2(150),
    operacao VARCHAR2(20),
    id_registro VARCHAR2(50),
    valor_antigo CLOB,
    valor_novo CLOB,
    data_evento DATE DEFAULT SYSDATE,
    usuario_responsavel VARCHAR2(150)
);


-- =====================================================================
-- TRIGGERS DE AUDITORIA
-- =====================================================================

-- TRIGGER: USUARIO
CREATE OR REPLACE TRIGGER trg_aud_usuario
AFTER INSERT OR UPDATE OR DELETE ON usuario
FOR EACH ROW
DECLARE
  v_operacao VARCHAR2(20);
BEGIN
  IF INSERTING THEN v_operacao := 'INSERT';
  ELSIF UPDATING THEN v_operacao := 'UPDATE';
  ELSIF DELETING THEN v_operacao := 'DELETE';
  END IF;

  INSERT INTO auditoria (tabela_afetada, operacao, id_registro, valor_antigo, valor_novo, usuario_responsavel)
  VALUES (
    'USUARIO',
    v_operacao,
    NVL(:OLD.id_usuario, :NEW.id_usuario),
    :OLD.nome,
    :NEW.nome,
    USER
  );
END trg_aud_usuario;


-- TRIGGER: EMPRESA
CREATE OR REPLACE TRIGGER trg_aud_empresa
AFTER INSERT OR UPDATE OR DELETE ON empresa
FOR EACH ROW
DECLARE
  v_operacao VARCHAR2(20);
BEGIN
  IF INSERTING THEN v_operacao := 'INSERT';
  ELSIF UPDATING THEN v_operacao := 'UPDATE';
  ELSIF DELETING THEN v_operacao := 'DELETE';
  END IF;

  INSERT INTO auditoria (tabela_afetada, operacao, id_registro, valor_antigo, valor_novo, usuario_responsavel)
  VALUES (
    'EMPRESA',
    v_operacao,
    NVL(:OLD.id_empresa, :NEW.id_empresa),
    :OLD.nome_fantasia,
    :NEW.nome_fantasia,
    USER
  );
END trg_aud_empresa;


-- TRIGGER: VAGA
CREATE OR REPLACE TRIGGER trg_aud_vaga
AFTER INSERT OR UPDATE OR DELETE ON vaga
FOR EACH ROW
DECLARE
  v_operacao VARCHAR2(20);
BEGIN
  IF INSERTING THEN v_operacao := 'INSERT';
  ELSIF UPDATING THEN v_operacao := 'UPDATE';
  ELSIF DELETING THEN v_operacao := 'DELETE';
  END IF;

  INSERT INTO auditoria (tabela_afetada, operacao, id_registro, valor_antigo, valor_novo, usuario_responsavel)
  VALUES (
    'VAGA',
    v_operacao,
    NVL(:OLD.id_vaga, :NEW.id_vaga),
    :OLD.titulo_vaga,
    :NEW.titulo_vaga,
    USER
  );
END trg_aud_vaga;


-- TRIGGER: CURSO
CREATE OR REPLACE TRIGGER trg_aud_curso
AFTER INSERT OR UPDATE OR DELETE ON curso
FOR EACH ROW
DECLARE
  v_operacao VARCHAR2(20);
BEGIN
  IF INSERTING THEN v_operacao := 'INSERT';
  ELSIF UPDATING THEN v_operacao := 'UPDATE';
  ELSIF DELETING THEN v_operacao := 'DELETE';
  END IF;

  INSERT INTO auditoria (tabela_afetada, operacao, id_registro, valor_antigo, valor_novo, usuario_responsavel)
  VALUES (
    'CURSO',
    v_operacao,
    NVL(:OLD.id_curso, :NEW.id_curso),
    :OLD.nome_curso,
    :NEW.nome_curso,
    USER
  );
END trg_aud_curso;


-- TRIGGER: COMPETENCIA
CREATE OR REPLACE TRIGGER trg_aud_competencia
AFTER INSERT OR UPDATE OR DELETE ON competencia
FOR EACH ROW
DECLARE
  v_operacao VARCHAR2(20);
BEGIN
  IF INSERTING THEN v_operacao := 'INSERT';
  ELSIF UPDATING THEN v_operacao := 'UPDATE';
  ELSIF DELETING THEN v_operacao := 'DELETE';
  END IF;

  INSERT INTO auditoria (tabela_afetada, operacao, id_registro, valor_antigo, valor_novo, usuario_responsavel)
  VALUES (
    'COMPETENCIA',
    v_operacao,
    NVL(:OLD.id_competencia, :NEW.id_competencia),
    :OLD.nome_competencia,
    :NEW.nome_competencia,
    USER
  );
END trg_aud_competencia;


-- TRIGGER: USUARIO_COMPETENCIA
CREATE OR REPLACE TRIGGER trg_aud_usuario_competencia
AFTER INSERT OR UPDATE OR DELETE ON usuario_competencia
FOR EACH ROW
DECLARE
  v_operacao VARCHAR2(20);
BEGIN
  IF INSERTING THEN v_operacao := 'INSERT';
  ELSIF UPDATING THEN v_operacao := 'UPDATE';
  ELSIF DELETING THEN v_operacao := 'DELETE';
  END IF;

  INSERT INTO auditoria (tabela_afetada, operacao, id_registro, usuario_responsavel)
  VALUES (
    'USUARIO_COMPETENCIA',
    v_operacao,
    TO_CHAR(NVL(:OLD.id_usuario, :NEW.id_usuario)) || '-' || TO_CHAR(NVL(:OLD.id_competencia, :NEW.id_competencia)),
    USER
  );
END trg_aud_usuario_competencia;


-- TRIGGER: VAGA_COMPETENCIA
CREATE OR REPLACE TRIGGER trg_aud_vaga_competencia
AFTER INSERT OR UPDATE OR DELETE ON vaga_competencia
FOR EACH ROW
DECLARE
  v_operacao VARCHAR2(20);
BEGIN
  IF INSERTING THEN v_operacao := 'INSERT';
  ELSIF UPDATING THEN v_operacao := 'UPDATE';
  ELSIF DELETING THEN v_operacao := 'DELETE';
  END IF;

  INSERT INTO auditoria (tabela_afetada, operacao, id_registro, usuario_responsavel)
  VALUES (
    'VAGA_COMPETENCIA',
    v_operacao,
    TO_CHAR(NVL(:OLD.id_vaga, :NEW.id_vaga)) || '-' || TO_CHAR(NVL(:OLD.id_competencia, :NEW.id_competencia)),
    USER
  );
END trg_aud_vaga_competencia;


-- TRIGGER: RECOMENDACAO
CREATE OR REPLACE TRIGGER trg_aud_recomendacao
AFTER INSERT OR UPDATE OR DELETE ON recomendacao
FOR EACH ROW
DECLARE
  v_operacao VARCHAR2(20);
BEGIN
  IF INSERTING THEN v_operacao := 'INSERT';
  ELSIF UPDATING THEN v_operacao := 'UPDATE';
  ELSIF DELETING THEN v_operacao := 'DELETE';
  END IF;

  INSERT INTO auditoria (tabela_afetada, operacao, id_registro, usuario_responsavel)
  VALUES (
    'RECOMENDACAO',
    v_operacao,
    NVL(:OLD.id_recomendacao, :NEW.id_recomendacao),
    USER
  );
END trg_aud_recomendacao;




-- =====================================================================
-- PACOTE 1: PKG_USUARIO
-- Gestão de Usuários e seus Perfis
-- =====================================================================
CREATE OR REPLACE PACKAGE pkg_usuario AS
  
  -- Procedures de gerenciamento de usuários
  PROCEDURE prc_inserir_usuarios;
  PROCEDURE prc_inserir_usuario_competencia;
  
  -- Função de geração de JSON do perfil completo
  FUNCTION fn_gerar_json_usuario(p_id_usuario IN NUMBER) RETURN CLOB;
  
END pkg_usuario;


CREATE OR REPLACE PACKAGE BODY pkg_usuario AS

  -- =====================================================================
  -- PROCEDURE: PRC_INSERIR_USUARIOS
  -- Descrição: Insere 10 usuários de teste na base
  -- =====================================================================
  PROCEDURE prc_inserir_usuarios IS
  BEGIN
    INSERT INTO usuario (nome, data_nascimento, email, telefone, endereco, cpf, resumo_profissional)
    VALUES ('Luiz Felipe', DATE '1998-06-21', 'luiz.felipe@nextjob.com', '(11)90000-1001', 'São Paulo - SP', '123.456.789-00', 'Desenvolvedor full stack com foco em IA e automação.');
    INSERT INTO usuario (nome, data_nascimento, email, telefone, endereco, cpf, resumo_profissional)
    VALUES ('Matheus Munuera', DATE '1999-03-05', 'matheus.munuera@nextjob.com', '(11)90000-1002', 'São Paulo - SP', '321.654.987-00', 'Cientista de dados especializado em aprendizado de máquina.');
    INSERT INTO usuario (nome, data_nascimento, email, telefone, endereco, cpf, resumo_profissional)
    VALUES ('Pedro Gomes', DATE '1997-09-11', 'pedro.gomes@nextjob.com', '(11)90000-1003', 'Campinas - SP', '456.789.123-00', 'Designer UX/UI focado em experiência digital.');
    INSERT INTO usuario (nome, data_nascimento, email, telefone, endereco, cpf, resumo_profissional)
    VALUES ('Ana Souza', DATE '1996-02-14', 'ana.souza@nextjob.com', '(21)98888-4004', 'Rio de Janeiro - RJ', '987.654.321-00', 'Analista de BI com experiência em Power BI e SQL.');
    INSERT INTO usuario (nome, data_nascimento, email, telefone, endereco, cpf, resumo_profissional)
    VALUES ('João Silva', DATE '1995-10-09', 'joao.silva@nextjob.com', '(31)95555-4005', 'Belo Horizonte - MG', '159.753.486-00', 'Engenheiro de dados com foco em pipelines e Big Data.');
    INSERT INTO usuario (nome, data_nascimento, email, telefone, endereco, cpf, resumo_profissional)
    VALUES ('Carla Lima', DATE '1998-08-17', 'carla.lima@nextjob.com', '(41)97777-4006', 'Curitiba - PR', '753.951.258-00', 'Especialista em RH digital e transformação organizacional.');
    INSERT INTO usuario (nome, data_nascimento, email, telefone, endereco, cpf, resumo_profissional)
    VALUES ('Bruno Rocha', DATE '1994-04-20', 'bruno.rocha@nextjob.com', '(62)96666-4007', 'Goiânia - GO', '951.753.852-00', 'Desenvolvedor front-end com domínio em React e JavaScript.');
    INSERT INTO usuario (nome, data_nascimento, email, telefone, endereco, cpf, resumo_profissional)
    VALUES ('Fernanda Alves', DATE '1993-12-05', 'fernanda.alves@nextjob.com', '(19)98888-4008', 'Campinas - SP', '852.147.963-00', 'Gestora de projetos com foco em metodologias ágeis.');
    INSERT INTO usuario (nome, data_nascimento, email, telefone, endereco, cpf, resumo_profissional)
    VALUES ('Ricardo Nunes', DATE '1990-05-22', 'ricardo.nunes@nextjob.com', '(11)98888-4009', 'São Paulo - SP', '357.159.486-00', 'Analista financeiro com experiência em automação de relatórios.');
    INSERT INTO usuario (nome, data_nascimento, email, telefone, endereco, cpf, resumo_profissional)
    VALUES ('Beatriz Castro', DATE '1999-07-18', 'beatriz.castro@nextjob.com', '(27)97777-4010', 'Vitória - ES', '258.963.147-00', 'Profissional de marketing digital orientada por dados.');
    
    DBMS_OUTPUT.PUT_LINE('✓ 10 usuários inseridos com sucesso!');
  END prc_inserir_usuarios;

  -- =====================================================================
  -- PROCEDURE: PRC_INSERIR_USUARIO_COMPETENCIA
  -- Descrição: Relaciona usuários com suas competências
  -- =====================================================================
  PROCEDURE prc_inserir_usuario_competencia IS
  BEGIN
    INSERT INTO usuario_competencia VALUES (1, 1, 'Avançado', 3, 'S', 'Superior Completo', SYSDATE);
    INSERT INTO usuario_competencia VALUES (1, 4, 'Avançado', 4, 'S', 'Superior Completo', SYSDATE);
    INSERT INTO usuario_competencia VALUES (2, 2, 'Avançado', 3, 'S', 'Superior Completo', SYSDATE);
    INSERT INTO usuario_competencia VALUES (2, 10, 'Avançado', 2, 'S', 'Superior Completo', SYSDATE);
    INSERT INTO usuario_competencia VALUES (3, 9, 'Intermediário', 2, 'N', 'Superior Completo', SYSDATE);
    INSERT INTO usuario_competencia VALUES (4, 6, 'Avançado', 4, 'S', 'Superior Completo', SYSDATE);
    INSERT INTO usuario_competencia VALUES (5, 4, 'Avançado', 5, 'S', 'Superior Completo', SYSDATE);
    INSERT INTO usuario_competencia VALUES (6, 5, 'Intermediário', 3, 'S', 'Superior Completo', SYSDATE);
    INSERT INTO usuario_competencia VALUES (7, 9, 'Avançado', 3, 'S', 'Superior Completo', SYSDATE);
    INSERT INTO usuario_competencia VALUES (8, 7, 'Avançado', 6, 'S', 'Pós-Graduação', SYSDATE);
    
    DBMS_OUTPUT.PUT_LINE('✓ Relacionamentos usuário-competência inseridos!');
  END prc_inserir_usuario_competencia;

  -- =====================================================================
  -- FUNÇÃO: FN_GERAR_JSON_USUARIO
  -- Descrição: Gera JSON completo do perfil do usuário
  -- =====================================================================
  FUNCTION fn_gerar_json_usuario(p_id_usuario IN NUMBER)
  RETURN CLOB IS
    v_json_resultado CLOB := '{';
    v_nome usuario.nome%TYPE;
    v_email usuario.email%TYPE;
    v_cpf usuario.cpf%TYPE;
    v_competencias CLOB := '';
    v_cursos CLOB := '';
    v_recomendacoes CLOB := '';
    
    -- Função auxiliar para escapar aspas duplas
    FUNCTION esc(p VARCHAR2) RETURN VARCHAR2 IS
    BEGIN
      IF p IS NULL THEN RETURN ''; END IF;
      RETURN REPLACE(p,'"','\"');
    END;
    
  BEGIN
    -- Buscar dados básicos do usuário
    SELECT nome, email, cpf
    INTO v_nome, v_email, v_cpf
    FROM usuario
    WHERE id_usuario = p_id_usuario;
    
    -- Buscar competências
    v_competencias := '[';
    FOR r IN (
      SELECT c.nome_competencia, c.tipo_competencia, uc.nivel_usuario
      FROM usuario_competencia uc
      JOIN competencia c ON c.id_competencia = uc.id_competencia
      WHERE uc.id_usuario = p_id_usuario
    ) LOOP
      IF v_competencias != '[' THEN v_competencias := v_competencias || ', '; END IF;
      v_competencias := v_competencias || 
        '{"competencia": "'||esc(r.nome_competencia)||'", "tipo": "'||esc(r.tipo_competencia)||'", "nivel": "'||esc(r.nivel_usuario)||'"}';
    END LOOP;
    v_competencias := v_competencias || ']';
    
    -- Buscar cursos recomendados
    v_cursos := '[';
    FOR r IN (
      SELECT c.nome_curso, c.plataforma, c.categoria
      FROM recomendacao r
      JOIN curso c ON c.id_curso = r.id_curso
      WHERE r.id_usuario = p_id_usuario AND r.tipo_recomendacao = 'CURSO'
    ) LOOP
      IF v_cursos != '[' THEN v_cursos := v_cursos || ', '; END IF;
      v_cursos := v_cursos ||
        '{"nome_curso": "'||esc(r.nome_curso)||'", "plataforma": "'||esc(r.plataforma)||'", "categoria": "'||esc(r.categoria)||'"}';
    END LOOP;
    v_cursos := v_cursos || ']';
    
    -- Buscar vagas recomendadas
    v_recomendacoes := '[';
    FOR r IN (
      SELECT v.titulo_vaga, v.senioridade, rec.nivel_prioridade
      FROM recomendacao rec
      JOIN vaga v ON v.id_vaga = rec.id_vaga
      WHERE rec.id_usuario = p_id_usuario AND rec.tipo_recomendacao = 'VAGA'
    ) LOOP
      IF v_recomendacoes != '[' THEN v_recomendacoes := v_recomendacoes || ', '; END IF;
      v_recomendacoes := v_recomendacoes ||
        '{"vaga": "'||esc(r.titulo_vaga)||'", "senioridade": "'||esc(r.senioridade)||'", "prioridade": "'||esc(r.nivel_prioridade)||'"}';
    END LOOP;
    v_recomendacoes := v_recomendacoes || ']';
    
    -- Montar JSON final manualmente
    v_json_resultado := v_json_resultado ||
      '"id_usuario": '||p_id_usuario||','||
      '"nome": "'||esc(v_nome)||'",'||
      '"email": "'||esc(v_email)||'",'||
      '"cpf": "'||esc(v_cpf)||'",'||
      '"competencias": '||v_competencias||','||
      '"cursos_recomendados": '||v_cursos||','||
      '"vagas_recomendadas": '||v_recomendacoes||'}';
    
    RETURN v_json_resultado;
    
  EXCEPTION
    WHEN NO_DATA_FOUND THEN
      RETURN '{"erro": "Usuário não encontrado"}';
    WHEN TOO_MANY_ROWS THEN
      RETURN '{"erro": "Inconsistência: múltiplos registros para o mesmo usuário"}';
    WHEN VALUE_ERROR THEN
      RETURN '{"erro": "Erro de conversão de dados"}';
    WHEN OTHERS THEN
      RETURN '{"erro": "Erro inesperado: '||REPLACE(SQLERRM,'"','\"')||'"}';
  END fn_gerar_json_usuario;

END pkg_usuario;



-- =====================================================================
-- PACOTE 2: PKG_VAGA
-- Gestão de Vagas, Empresas e Compatibilidade
-- =====================================================================
CREATE OR REPLACE PACKAGE pkg_vaga AS
  
  -- Procedures de gerenciamento de vagas
  PROCEDURE prc_inserir_empresas;
  PROCEDURE prc_inserir_vagas;
  PROCEDURE prc_inserir_vaga_competencia;
  
  -- Função de cálculo de compatibilidade
  FUNCTION fn_calcular_compatibilidade(
    p_id_usuario IN NUMBER,
    p_id_vaga IN NUMBER
  ) RETURN CLOB;
  
END pkg_vaga;


CREATE OR REPLACE PACKAGE BODY pkg_vaga AS

  -- =====================================================================
  -- PROCEDURE: PRC_INSERIR_EMPRESAS
  -- Descrição: Insere 10 empresas parceiras na base
  -- =====================================================================
  PROCEDURE prc_inserir_empresas IS
  BEGIN
    INSERT INTO empresa (nome_fantasia, razao_social, cnpj, area_atuacao, porte_empresa, telefone, email_corporativo, endereco)
    VALUES ('TechNova', 'TechNova Soluções em TI LTDA', '12.345.678/0001-01', 'Tecnologia', 'Médio Porte', '(11)3333-1111', 'contato@technova.com', 'Av. Paulista, 1000, São Paulo');
    INSERT INTO empresa (nome_fantasia, razao_social, cnpj, area_atuacao, porte_empresa, telefone, email_corporativo, endereco)
    VALUES ('EduFuture', 'EduFuture Educação Digital S.A.', '23.456.789/0001-02', 'Educação', 'Grande Porte', '(11)4002-8922', 'contato@edufuture.com', 'Rua Vergueiro, 2500, São Paulo');
    INSERT INTO empresa (nome_fantasia, razao_social, cnpj, area_atuacao, porte_empresa, telefone, email_corporativo, endereco)
    VALUES ('HealthTech AI', 'HealthTech AI Ltda', '34.567.890/0001-03', 'Saúde e Tecnologia', 'Startup', '(21)99999-1234', 'hr@healthtech.com', 'Rua das Flores, 300, Rio de Janeiro');
    INSERT INTO empresa (nome_fantasia, razao_social, cnpj, area_atuacao, porte_empresa, telefone, email_corporativo, endereco)
    VALUES ('AgroData', 'AgroData Inteligência Agrícola LTDA', '45.678.901/0001-04', 'AgroTech', 'Startup', '(62)98888-1000', 'contato@agrodata.com', 'Av. Goiás, 110, Goiânia');
    INSERT INTO empresa (nome_fantasia, razao_social, cnpj, area_atuacao, porte_empresa, telefone, email_corporativo, endereco)
    VALUES ('RoboLink', 'RoboLink Indústria 4.0 LTDA', '56.789.012/0001-05', 'Automação', 'Médio Porte', '(41)3222-5555', 'hr@robolink.com', 'Rua XV de Novembro, Curitiba');
    INSERT INTO empresa (nome_fantasia, razao_social, cnpj, area_atuacao, porte_empresa, telefone, email_corporativo, endereco)
    VALUES ('FinAI', 'FinAI Soluções Financeiras LTDA', '67.890.123/0001-06', 'Finanças e IA', 'Startup', '(11)4004-1234', 'contato@finai.com', 'Av. Faria Lima, 400, São Paulo');
    INSERT INTO empresa (nome_fantasia, razao_social, cnpj, area_atuacao, porte_empresa, telefone, email_corporativo, endereco)
    VALUES ('NextStep', 'NextStep Consultoria Ltda', '78.901.234/0001-07', 'Consultoria', 'Pequeno Porte', '(11)3222-1000', 'rh@nextstep.com', 'Av. Angélica, 500, São Paulo');
    INSERT INTO empresa (nome_fantasia, razao_social, cnpj, area_atuacao, porte_empresa, telefone, email_corporativo, endereco)
    VALUES ('GreenEnergy', 'GreenEnergy Sustentável S.A.', '89.012.345/0001-08', 'Energia', 'Grande Porte', '(31)3333-5555', 'contato@greenenergy.com', 'Av. Amazonas, 900, Belo Horizonte');
    INSERT INTO empresa (nome_fantasia, razao_social, cnpj, area_atuacao, porte_empresa, telefone, email_corporativo, endereco)
    VALUES ('MobiWork', 'MobiWork Mobilidade LTDA', '90.123.456/0001-09', 'Transporte', 'Startup', '(19)4002-8899', 'atendimento@mobiwork.com', 'Rua Barão de Campinas, Campinas');
    INSERT INTO empresa (nome_fantasia, razao_social, cnpj, area_atuacao, porte_empresa, telefone, email_corporativo, endereco)
    VALUES ('NextJob AI', 'NextJob Inteligência de Carreiras LTDA', '01.234.567/0001-10', 'Recursos Humanos', 'Startup', '(11)90000-0000', 'contato@nextjob.com', 'Av. Rebouças, 2000, São Paulo');
    
    DBMS_OUTPUT.PUT_LINE('✓ 10 empresas inseridas com sucesso!');
  END prc_inserir_empresas;

  -- =====================================================================
  -- PROCEDURE: PRC_INSERIR_VAGAS
  -- Descrição: Insere 10 vagas de emprego na base
  -- =====================================================================
  PROCEDURE prc_inserir_vagas IS
  BEGIN
    INSERT INTO vaga (id_empresa, titulo_vaga, senioridade, salario, carga_horaria_semana, tipo_contrato, localizacao, descricao_completa, quantidade_vagas, status_vaga)
    VALUES (1, 'Desenvolvedor Python', 'Pleno', 7500, 40, 'CLT', 'Remoto', 'Desenvolvimento de aplicações com Python e IA.', 2, 'Ativa');
    INSERT INTO vaga (id_empresa, titulo_vaga, senioridade, salario, carga_horaria_semana, tipo_contrato, localizacao, descricao_completa, quantidade_vagas, status_vaga)
    VALUES (2, 'Cientista de Dados', 'Sênior', 9500, 40, 'PJ', 'Remoto', 'Modelagem preditiva e análise de dados.', 1, 'Ativa');
    INSERT INTO vaga (id_empresa, titulo_vaga, senioridade, salario, carga_horaria_semana, tipo_contrato, localizacao, descricao_completa, quantidade_vagas, status_vaga)
    VALUES (3, 'Analista de BI', 'Pleno', 8000, 40, 'CLT', 'São Paulo', 'Desenvolver dashboards e relatórios.', 1, 'Ativa');
    INSERT INTO vaga (id_empresa, titulo_vaga, senioridade, salario, carga_horaria_semana, tipo_contrato, localizacao, descricao_completa, quantidade_vagas, status_vaga)
    VALUES (4, 'Desenvolvedor Front-End', 'Júnior', 5500, 40, 'CLT', 'Híbrido', 'Criação de interfaces com JS e React.', 2, 'Ativa');
    INSERT INTO vaga (id_empresa, titulo_vaga, senioridade, salario, carga_horaria_semana, tipo_contrato, localizacao, descricao_completa, quantidade_vagas, status_vaga)
    VALUES (5, 'Engenheiro de Dados', 'Pleno', 8800, 40, 'PJ', 'Remoto', 'Pipeline e ETL em cloud.', 1, 'Ativa');
    INSERT INTO vaga (id_empresa, titulo_vaga, senioridade, salario, carga_horaria_semana, tipo_contrato, localizacao, descricao_completa, quantidade_vagas, status_vaga)
    VALUES (6, 'Especialista em IA', 'Sênior', 12000, 40, 'PJ', 'Remoto', 'Implementação de IA generativa.', 1, 'Ativa');
    INSERT INTO vaga (id_empresa, titulo_vaga, senioridade, salario, carga_horaria_semana, tipo_contrato, localizacao, descricao_completa, quantidade_vagas, status_vaga)
    VALUES (7, 'Analista de RH Digital', 'Pleno', 6500, 40, 'CLT', 'São Paulo', 'Recrutamento com apoio de IA.', 1, 'Ativa');
    INSERT INTO vaga (id_empresa, titulo_vaga, senioridade, salario, carga_horaria_semana, tipo_contrato, localizacao, descricao_completa, quantidade_vagas, status_vaga)
    VALUES (8, 'Gestor de Projetos', 'Sênior', 10000, 40, 'CLT', 'Híbrido', 'Gestão de times multidisciplinares.', 1, 'Ativa');
    INSERT INTO vaga (id_empresa, titulo_vaga, senioridade, salario, carga_horaria_semana, tipo_contrato, localizacao, descricao_completa, quantidade_vagas, status_vaga)
    VALUES (9, 'Especialista em Sustentabilidade', 'Pleno', 8500, 40, 'CLT', 'Remoto', 'Planejar ações ESG.', 1, 'Ativa');
    INSERT INTO vaga (id_empresa, titulo_vaga, senioridade, salario, carga_horaria_semana, tipo_contrato, localizacao, descricao_completa, quantidade_vagas, status_vaga)
    VALUES (10, 'Engenheiro de Machine Learning', 'Sênior', 11000, 40, 'PJ', 'Remoto', 'Modelos de IA generativa aplicados a negócios.', 1, 'Ativa');
    
    DBMS_OUTPUT.PUT_LINE('✓ 10 vagas inseridas com sucesso!');
  END prc_inserir_vagas;

  -- =====================================================================
  -- PROCEDURE: PRC_INSERIR_VAGA_COMPETENCIA
  -- =====================================================================
  PROCEDURE prc_inserir_vaga_competencia IS
  BEGIN
    INSERT INTO vaga_competencia VALUES (1, 1, 'S', 'Avançado');
    INSERT INTO vaga_competencia VALUES (2, 2, 'S', 'Avançado');
    INSERT INTO vaga_competencia VALUES (3, 6, 'S', 'Intermediário');
    INSERT INTO vaga_competencia VALUES (4, 9, 'S', 'Intermediário');
    INSERT INTO vaga_competencia VALUES (5, 4, 'S', 'Avançado');
    INSERT INTO vaga_competencia VALUES (6, 2, 'S', 'Avançado');
    INSERT INTO vaga_competencia VALUES (7, 5, 'N', 'Intermediário');
    INSERT INTO vaga_competencia VALUES (8, 7, 'S', 'Avançado');
    INSERT INTO vaga_competencia VALUES (9, 3, 'N', 'Intermediário');
    INSERT INTO vaga_competencia VALUES (10, 1, 'S', 'Avançado');
    
    DBMS_OUTPUT.PUT_LINE('✓ Relacionamentos vaga-competência inseridos!');
  END prc_inserir_vaga_competencia;

  -- =====================================================================
  -- FUNÇÃO: FN_CALCULAR_COMPATIBILIDADE
  -- =====================================================================
  FUNCTION fn_calcular_compatibilidade(
    p_id_usuario IN NUMBER,
    p_id_vaga IN NUMBER
  ) RETURN CLOB IS
    v_total_competencias NUMBER := 0;
    v_match NUMBER := 0;
    v_percentual NUMBER;
    v_email usuario.email%TYPE;
    v_cpf usuario.cpf%TYPE;
    v_json_resultado CLOB;

    ex_email_invalido EXCEPTION;
    ex_cpf_invalido EXCEPTION;

  BEGIN
    SELECT email, cpf INTO v_email, v_cpf FROM usuario WHERE id_usuario = p_id_usuario;

    IF NOT REGEXP_LIKE(v_email, '^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$') THEN
      RAISE ex_email_invalido;
    END IF;

    IF NOT REGEXP_LIKE(v_cpf, '^[0-9]{3}\.?[0-9]{3}\.?[0-9]{3}\-?[0-9]{2}$') THEN
      RAISE ex_cpf_invalido;
    END IF;

    SELECT COUNT(*) INTO v_total_competencias FROM vaga_competencia WHERE id_vaga = p_id_vaga;

    SELECT COUNT(*) INTO v_match
    FROM vaga_competencia vc
    JOIN usuario_competencia uc ON vc.id_competencia = uc.id_competencia
    WHERE vc.id_vaga = p_id_vaga
      AND uc.id_usuario = p_id_usuario;

    IF v_total_competencias = 0 THEN
      RETURN '{"erro": "Vaga sem competências registradas"}';
    END IF;

    v_percentual := ROUND((v_match / v_total_competencias) * 100, 2);

    v_json_resultado := '{' ||
      '"usuario_id": ' || p_id_usuario || ',' ||
      '"vaga_id": ' || p_id_vaga || ',' ||
      '"compatibilidade": "' || TO_CHAR(v_percentual, 'FM999990.00') || '%",' ||
      '"competencias_exigidas": ' || v_total_competencias || ',' ||
      '"competencias_correspondentes": ' || v_match || '}';

    RETURN v_json_resultado;

  EXCEPTION
    WHEN ex_email_invalido THEN
      RETURN '{"erro": "E-mail inválido"}';
    WHEN ex_cpf_invalido THEN
      RETURN '{"erro": "CPF inválido"}';
    WHEN NO_DATA_FOUND THEN
      RETURN '{"erro": "Usuário ou vaga não encontrados"}';
    WHEN ZERO_DIVIDE THEN
      RETURN '{"erro": "Divisão por zero detectada"}';
    WHEN VALUE_ERROR THEN
      RETURN '{"erro": "Erro de valor/conversão"}';
    WHEN OTHERS THEN
      RETURN '{"erro": "Erro inesperado: ' || REPLACE(SQLERRM,'"','\"') || '"}';
  END fn_calcular_compatibilidade;

END pkg_vaga;



-- =====================================================================
-- PACOTE 3: PKG_CONHECIMENTO
-- Área Lógica: Base de Conhecimento (Competências e Cursos)
-- =====================================================================
CREATE OR REPLACE PACKAGE pkg_conhecimento AS
  
  -- Procedures de gerenciamento de conhecimento
  PROCEDURE prc_inserir_competencias;
  PROCEDURE prc_inserir_cursos;
  
  -- Função auxiliar para listar cursos por categoria
  FUNCTION fn_listar_cursos_por_categoria(p_categoria IN VARCHAR2) RETURN CLOB;
  
END pkg_conhecimento;


CREATE OR REPLACE PACKAGE BODY pkg_conhecimento AS

  -- =====================================================================
  -- PROCEDURE: PRC_INSERIR_COMPETENCIAS
  -- Descrição: Insere 10 competências técnicas e soft skills
  -- =====================================================================
  PROCEDURE prc_inserir_competencias IS
  BEGIN
    INSERT INTO competencia (nome_competencia, tipo_competencia, categoria, descricao, nivel_referencial)
    VALUES ('Python', 'Técnica', 'Programação', 'Linguagem essencial para IA e automação.', 'Avançado');
    INSERT INTO competencia (nome_competencia, tipo_competencia, categoria, descricao, nivel_referencial)
    VALUES ('Machine Learning', 'Técnica', 'IA', 'Modelagem e predição de dados.', 'Avançado');
    INSERT INTO competencia (nome_competencia, tipo_competencia, categoria, descricao, nivel_referencial)
    VALUES ('Comunicação', 'Soft Skill', 'Comportamental', 'Habilidade interpessoal para trabalho remoto.', 'Intermediário');
    INSERT INTO competencia (nome_competencia, tipo_competencia, categoria, descricao, nivel_referencial)
    VALUES ('SQL', 'Técnica', 'Banco de Dados', 'Manipulação de dados estruturados.', 'Avançado');
    INSERT INTO competencia (nome_competencia, tipo_competencia, categoria, descricao, nivel_referencial)
    VALUES ('Liderança', 'Soft Skill', 'Gestão', 'Capacidade de liderar equipes ágeis.', 'Intermediário');
    INSERT INTO competencia (nome_competencia, tipo_competencia, categoria, descricao, nivel_referencial)
    VALUES ('Power BI', 'Técnica', 'Análise de Dados', 'Visualização e relatórios.', 'Intermediário');
    INSERT INTO competencia (nome_competencia, tipo_competencia, categoria, descricao, nivel_referencial)
    VALUES ('Gestão de Projetos', 'Soft Skill', 'Gerencial', 'Planejamento e execução de tarefas.', 'Avançado');
    INSERT INTO competencia (nome_competencia, tipo_competencia, categoria, descricao, nivel_referencial)
    VALUES ('Inglês Técnico', 'Soft Skill', 'Linguístico', 'Leitura e escrita técnica em inglês.', 'Avançado');
    INSERT INTO competencia (nome_competencia, tipo_competencia, categoria, descricao, nivel_referencial)
    VALUES ('JavaScript', 'Técnica', 'Desenvolvimento Web', 'Front-end moderno.', 'Intermediário');
    INSERT INTO competencia (nome_competencia, tipo_competencia, categoria, descricao, nivel_referencial)
    VALUES ('Análise de Dados', 'Técnica', 'Data Science', 'Coleta e tratamento de dados.', 'Avançado');
    
    DBMS_OUTPUT.PUT_LINE('✓ 10 competências inseridas com sucesso!');
  END prc_inserir_competencias;

  -- =====================================================================
  -- PROCEDURE: PRC_INSERIR_CURSOS
  -- Descrição: Insere 10 cursos de capacitação na base
  -- =====================================================================
  PROCEDURE prc_inserir_cursos IS
  BEGIN
    INSERT INTO curso (nome_curso, plataforma, categoria, carga_horaria, gratuito, descricao)
    VALUES ('Python para Iniciantes', 'Coursera', 'Programação', 40, 'S', 'Aprenda lógica e Python básico.');
    INSERT INTO curso (nome_curso, plataforma, categoria, carga_horaria, gratuito, descricao)
    VALUES ('Machine Learning com IA', 'Alura', 'Inteligência Artificial', 60, 'N', 'Modelos supervisionados e não supervisionados.');
    INSERT INTO curso (nome_curso, plataforma, categoria, carga_horaria, gratuito, descricao)
    VALUES ('SQL Avançado', 'DIO', 'Banco de Dados', 30, 'S', 'Consultas complexas e joins.');
    INSERT INTO curso (nome_curso, plataforma, categoria, carga_horaria, gratuito, descricao)
    VALUES ('Power BI para Negócios', 'Udemy', 'Análise de Dados', 35, 'S', 'Dashboards e relatórios dinâmicos.');
    INSERT INTO curso (nome_curso, plataforma, categoria, carga_horaria, gratuito, descricao)
    VALUES ('Comunicação Assertiva', 'Senac', 'Soft Skills', 25, 'S', 'Melhore sua comunicação no ambiente profissional.');
    INSERT INTO curso (nome_curso, plataforma, categoria, carga_horaria, gratuito, descricao)
    VALUES ('Gestão Ágil de Projetos', 'Alura', 'Gestão', 50, 'N', 'Scrum e Kanban para equipes modernas.');
    INSERT INTO curso (nome_curso, plataforma, categoria, carga_horaria, gratuito, descricao)
    VALUES ('Fundamentos de IA', 'FutureLearn', 'Tecnologia', 45, 'S', 'Conceitos e aplicações da IA.');
    INSERT INTO curso (nome_curso, plataforma, categoria, carga_horaria, gratuito, descricao)
    VALUES ('Inglês para Profissionais de TI', 'Udemy', 'Idiomas', 20, 'S', 'Vocabulário e leitura técnica.');
    INSERT INTO curso (nome_curso, plataforma, categoria, carga_horaria, gratuito, descricao)
    VALUES ('Desenvolvimento Web com JS', 'FreeCodeCamp', 'Programação', 100, 'S', 'HTML, CSS e JavaScript moderno.');
    INSERT INTO curso (nome_curso, plataforma, categoria, carga_horaria, gratuito, descricao)
    VALUES ('Data Science na Prática', 'Coursera', 'Data Science', 70, 'N', 'Manipulação e análise de dados.');
    
    DBMS_OUTPUT.PUT_LINE('✓ 10 cursos inseridos com sucesso!');
  END prc_inserir_cursos;

  -- =====================================================================
  -- FUNÇÃO: FN_LISTAR_CURSOS_POR_CATEGORIA
  -- Descrição: Lista cursos filtrados por categoria em formato JSON
  -- =====================================================================
  FUNCTION fn_listar_cursos_por_categoria(p_categoria IN VARCHAR2)
  RETURN CLOB IS
    v_json_resultado CLOB := '{"categoria": "'||p_categoria||'", "cursos": [';
    v_primeiro BOOLEAN := TRUE;
  BEGIN
    FOR r IN (
      SELECT nome_curso, plataforma, carga_horaria, gratuito
      FROM curso
      WHERE UPPER(categoria) = UPPER(p_categoria)
      ORDER BY nome_curso
    ) LOOP
      IF NOT v_primeiro THEN
        v_json_resultado := v_json_resultado || ', ';
      END IF;
      v_json_resultado := v_json_resultado ||
        '{"nome": "'||REPLACE(r.nome_curso,'"','\"')||'", ' ||
        '"plataforma": "'||REPLACE(r.plataforma,'"','\"')||'", ' ||
        '"carga_horaria": '||r.carga_horaria||', ' ||
        '"gratuito": "'||r.gratuito||'"}';
      v_primeiro := FALSE;
    END LOOP;
    
    v_json_resultado := v_json_resultado || ']}';
    RETURN v_json_resultado;
    
  EXCEPTION
    WHEN OTHERS THEN
      RETURN '{"erro": "Erro ao listar cursos: '||REPLACE(SQLERRM,'"','\"')||'"}';
  END fn_listar_cursos_por_categoria;

END pkg_conhecimento;



-- =====================================================================
-- PACOTE 4: PKG_RECOMENDACAO
-- Área Lógica: Sistema de Recomendações Inteligentes
-- =====================================================================
CREATE OR REPLACE PACKAGE pkg_recomendacao AS
  
  -- Procedure de gerenciamento de recomendações
  PROCEDURE prc_inserir_recomendacoes;
  
  -- Função para gerar recomendações personalizadas
  FUNCTION fn_gerar_recomendacoes_usuario(p_id_usuario IN NUMBER) RETURN CLOB;
  
END pkg_recomendacao;


CREATE OR REPLACE PACKAGE BODY pkg_recomendacao AS

  -- =====================================================================
  -- PROCEDURE: PRC_INSERIR_RECOMENDACOES
  -- Descrição: Insere recomendações de vagas e cursos
  -- =====================================================================
  PROCEDURE prc_inserir_recomendacoes IS
  BEGIN
    INSERT INTO recomendacao (id_usuario, id_vaga, id_curso, tipo_recomendacao, texto_recomendacao, nivel_prioridade)
    VALUES (1, 1, 1, 'CURSO', 'Recomendado aprimorar Python para IA avançada.', 'Alta');
    INSERT INTO recomendacao (id_usuario, id_vaga, id_curso, tipo_recomendacao, texto_recomendacao, nivel_prioridade)
    VALUES (2, 2, 2, 'CURSO', 'Aprofundar em Machine Learning aplicado.', 'Alta');
    INSERT INTO recomendacao (id_usuario, id_vaga, id_curso, tipo_recomendacao, texto_recomendacao, nivel_prioridade)
    VALUES (3, 4, 9, 'CURSO', 'Curso de JavaScript para expandir habilidades front-end.', 'Média');
    INSERT INTO recomendacao (id_usuario, id_vaga, id_curso, tipo_recomendacao, texto_recomendacao, nivel_prioridade)
    VALUES (4, 3, 4, 'CURSO', 'Aperfeiçoar SQL para análise de dados.', 'Alta');
    INSERT INTO recomendacao (id_usuario, id_vaga, id_curso, tipo_recomendacao, texto_recomendacao, nivel_prioridade)
    VALUES (5, 5, NULL, 'VAGA', 'Vaga de Engenheiro de Dados compatível com seu perfil.', 'Alta');
    INSERT INTO recomendacao (id_usuario, id_vaga, id_curso, tipo_recomendacao, texto_recomendacao, nivel_prioridade)
    VALUES (1, 1, NULL, 'VAGA', 'Desenvolvedor Python - Alta compatibilidade.', 'Alta');
    INSERT INTO recomendacao (id_usuario, id_vaga, id_curso, tipo_recomendacao, texto_recomendacao, nivel_prioridade)
    VALUES (2, 2, NULL, 'VAGA', 'Cientista de Dados - Perfil ideal.', 'Alta');
    INSERT INTO recomendacao (id_usuario, id_vaga, id_curso, tipo_recomendacao, texto_recomendacao, nivel_prioridade)
    VALUES (7, NULL, 6, 'CURSO', 'Gestão Ágil recomendada para sua carreira.', 'Média');
    INSERT INTO recomendacao (id_usuario, id_vaga, id_curso, tipo_recomendacao, texto_recomendacao, nivel_prioridade)
    VALUES (8, 8, 7, 'CURSO', 'Especialização em Gestão de Projetos.', 'Alta');
    INSERT INTO recomendacao (id_usuario, id_vaga, id_curso, tipo_recomendacao, texto_recomendacao, nivel_prioridade)
    VALUES (10, NULL, 5, 'CURSO', 'Comunicação Assertiva para profissionais de marketing.', 'Média');
    
    DBMS_OUTPUT.PUT_LINE('✓ Recomendações inseridas com sucesso!');
  END prc_inserir_recomendacoes;

  -- =====================================================================
  -- FUNÇÃO: FN_GERAR_RECOMENDACOES_USUARIO
  -- Descrição: Gera JSON com todas as recomendações do usuário
  -- =====================================================================
  FUNCTION fn_gerar_recomendacoes_usuario(p_id_usuario IN NUMBER)
  RETURN CLOB IS
    v_json_resultado CLOB := '{"usuario_id": '||p_id_usuario||', "recomendacoes": [';
    v_primeiro BOOLEAN := TRUE;
  BEGIN
    FOR r IN (
      SELECT tipo_recomendacao, texto_recomendacao, nivel_prioridade,
             v.titulo_vaga, c.nome_curso
      FROM recomendacao rec
      LEFT JOIN vaga v ON v.id_vaga = rec.id_vaga
      LEFT JOIN curso c ON c.id_curso = rec.id_curso
      WHERE rec.id_usuario = p_id_usuario
      ORDER BY 
        CASE nivel_prioridade 
          WHEN 'Alta' THEN 1 
          WHEN 'Média' THEN 2 
          ELSE 3 
        END
    ) LOOP
      IF NOT v_primeiro THEN
        v_json_resultado := v_json_resultado || ', ';
      END IF;
      v_json_resultado := v_json_resultado ||
        '{"tipo": "'||r.tipo_recomendacao||'", ' ||
        '"texto": "'||REPLACE(r.texto_recomendacao,'"','\"')||'", ' ||
        '"prioridade": "'||r.nivel_prioridade||'"';
      
      IF r.titulo_vaga IS NOT NULL THEN
        v_json_resultado := v_json_resultado || ', "vaga": "'||REPLACE(r.titulo_vaga,'"','\"')||'"';
      END IF;
      
      IF r.nome_curso IS NOT NULL THEN
        v_json_resultado := v_json_resultado || ', "curso": "'||REPLACE(r.nome_curso,'"','\"')||'"';
      END IF;
      
      v_json_resultado := v_json_resultado || '}';
      v_primeiro := FALSE;
    END LOOP;
    
    v_json_resultado := v_json_resultado || ']}';
    RETURN v_json_resultado;
    
  EXCEPTION
    WHEN OTHERS THEN
      RETURN '{"erro": "Erro ao gerar recomendações: '||REPLACE(SQLERRM,'"','\"')||'"}';
  END fn_gerar_recomendacoes_usuario;

END pkg_recomendacao;



-- =====================================================================
-- PACOTE 5: PKG_INICIALIZACAO
-- Área Lógica: Orquestração e Inicialização do Sistema
-- =====================================================================
CREATE OR REPLACE PACKAGE pkg_inicializacao AS
  
  -- Procedure principal de inicialização
  PROCEDURE prc_inicializar_banco_nextjob;
  
  -- Procedure auxiliar para validar integridade
  PROCEDURE prc_validar_integridade_dados;
  
END pkg_inicializacao;


CREATE OR REPLACE PACKAGE BODY pkg_inicializacao AS

  -- =====================================================================
  -- PROCEDURE: PRC_INICIALIZAR_BANCO_NEXTJOB
  -- Descrição: Orquestra a inicialização completa do banco de dados
  -- =====================================================================
  PROCEDURE prc_inicializar_banco_nextjob IS
  BEGIN
    DBMS_OUTPUT.PUT_LINE('');
    DBMS_OUTPUT.PUT_LINE('=======================================================');
    DBMS_OUTPUT.PUT_LINE('INICIALIZANDO SISTEMA NEXT JOB');
    DBMS_OUTPUT.PUT_LINE('=======================================================');
    DBMS_OUTPUT.PUT_LINE('');
    
    -- Chamar pacotes na ordem correta de dependências
    DBMS_OUTPUT.PUT_LINE('Inserindo empresas...');
    pkg_vaga.prc_inserir_empresas;
    
    DBMS_OUTPUT.PUT_LINE('Inserindo usuários...');
    pkg_usuario.prc_inserir_usuarios;
    
    DBMS_OUTPUT.PUT_LINE('Inserindo competências...');
    pkg_conhecimento.prc_inserir_competencias;
    
    DBMS_OUTPUT.PUT_LINE('Inserindo cursos...');
    pkg_conhecimento.prc_inserir_cursos;
    
    DBMS_OUTPUT.PUT_LINE('Inserindo vagas...');
    pkg_vaga.prc_inserir_vagas;
    
    DBMS_OUTPUT.PUT_LINE('Relacionando usuários e competências...');
    pkg_usuario.prc_inserir_usuario_competencia;
    
    DBMS_OUTPUT.PUT_LINE('Relacionando vagas e competências...');
    pkg_vaga.prc_inserir_vaga_competencia;
    
    DBMS_OUTPUT.PUT_LINE('Gerando recomendações...');
    pkg_recomendacao.prc_inserir_recomendacoes;
    
    COMMIT;
    
    DBMS_OUTPUT.PUT_LINE('');
    DBMS_OUTPUT.PUT_LINE('=======================================================');
    DBMS_OUTPUT.PUT_LINE('BANCO NEXT JOB INICIALIZADO COM SUCESSO!');
    DBMS_OUTPUT.PUT_LINE('=======================================================');
    DBMS_OUTPUT.PUT_LINE('');
    
  EXCEPTION
    WHEN OTHERS THEN
      ROLLBACK;
      DBMS_OUTPUT.PUT_LINE('');
      DBMS_OUTPUT.PUT_LINE('ERRO ao inicializar banco: ' || SQLERRM);
      DBMS_OUTPUT.PUT_LINE('');
      RAISE;
  END prc_inicializar_banco_nextjob;

  -- =====================================================================
  -- PROCEDURE: PRC_VALIDAR_INTEGRIDADE_DADOS
  -- Descrição: Valida a integridade dos dados após inicialização
  -- =====================================================================
  PROCEDURE prc_validar_integridade_dados IS
    v_count_empresas NUMBER;
    v_count_usuarios NUMBER;
    v_count_vagas NUMBER;
    v_count_competencias NUMBER;
    v_count_cursos NUMBER;
    v_count_recomendacoes NUMBER;
  BEGIN
    SELECT COUNT(*) INTO v_count_empresas FROM empresa;
    SELECT COUNT(*) INTO v_count_usuarios FROM usuario;
    SELECT COUNT(*) INTO v_count_vagas FROM vaga;
    SELECT COUNT(*) INTO v_count_competencias FROM competencia;
    SELECT COUNT(*) INTO v_count_cursos FROM curso;
    SELECT COUNT(*) INTO v_count_recomendacoes FROM recomendacao;
    
    DBMS_OUTPUT.PUT_LINE('');
    DBMS_OUTPUT.PUT_LINE('=======================================================');
    DBMS_OUTPUT.PUT_LINE('RELATÓRIO DE INTEGRIDADE');
    DBMS_OUTPUT.PUT_LINE('=======================================================');
    DBMS_OUTPUT.PUT_LINE('Empresas cadastradas: ' || v_count_empresas);
    DBMS_OUTPUT.PUT_LINE('Usuários cadastrados: ' || v_count_usuarios);
    DBMS_OUTPUT.PUT_LINE('Vagas ativas: ' || v_count_vagas);
    DBMS_OUTPUT.PUT_LINE('Competências registradas: ' || v_count_competencias);
    DBMS_OUTPUT.PUT_LINE('Cursos disponíveis: ' || v_count_cursos);
    DBMS_OUTPUT.PUT_LINE('Recomendações geradas: ' || v_count_recomendacoes);
    DBMS_OUTPUT.PUT_LINE('=======================================================');
    DBMS_OUTPUT.PUT_LINE('');
    
    -- Validações básicas
    IF v_count_usuarios = 0 THEN
      RAISE_APPLICATION_ERROR(-20001, 'ERRO: Nenhum usuário foi cadastrado!');
    END IF;
    
    IF v_count_vagas = 0 THEN
      RAISE_APPLICATION_ERROR(-20002, 'ERRO: Nenhuma vaga foi cadastrada!');
    END IF;
    
    DBMS_OUTPUT.PUT_LINE('✓ Validação de integridade concluída com sucesso!');
    DBMS_OUTPUT.PUT_LINE('');
    
  EXCEPTION
    WHEN OTHERS THEN
      DBMS_OUTPUT.PUT_LINE('✗ Erro na validação: ' || SQLERRM);
      RAISE;
  END prc_validar_integridade_dados;

END pkg_inicializacao;



-- =====================================================================
-- TESTES
-- =====================================================================

BEGIN
  PKG_INICIALIZACAO.PRC_INICIALIZAR_BANCO_NEXTJOB;
END;






